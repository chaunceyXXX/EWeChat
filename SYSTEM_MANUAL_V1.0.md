# 企业微信文件自动发送系统 - v1.0.0 系统手册

> **版本**: v1.0.0 (封版)  
> **发布日期**: 2026-02-07  
> **状态**: 已验证通过 (Stable)

---

## 1. 系统简介
本系统旨在解决**自动化文件分发**的需求。它能够实时或定时监控本地计算机上的指定文件夹，自动识别最新生成的文档（如 Word、Excel、PDF 等），并通过企业微信 API 将其推送到指定的企业微信群或个人。

### 核心功能
*   **文件夹监控**: 智能识别文件夹中修改时间最新的文件。
*   **企业微信推送**: 使用企业级 API 稳定推送文件。
*   **定时任务**: 支持自定义定时发送（如每天 10:29 自动发送）。
*   **Web 管理界面**: 提供可视化的配置面板、日志查看和状态监控。
*   **内网穿透集成**: 内置回调验证支持，确保企业微信后台配置顺利通过。

---

## 2. 系统架构

系统采用 **前后端分离** 架构，确保稳定性和扩展性。

### 技术栈
*   **前端 (Frontend)**: 
    *   **React 18**: 用于构建用户界面。
    *   **Vite**: 高性能构建工具。
    *   **TailwindCSS**: 现代 UI 样式库。
    *   **React Router**: 路由管理。
*   **后端 (Backend)**: 
    *   **Python 3.9+**: 核心逻辑语言。
    *   **FastAPI**: 高性能 Web 框架，提供 RESTful API。
    *   **WeChatPy (Enterprise)**: 处理企业微信加密/解密和 API 调用。
    *   **Schedule**: 处理定时任务逻辑。
*   **数据存储**:
    *   **JSON**: 使用 `config.json` 本地存储配置，无需安装数据库，轻量易迁移。

### 目录结构
```
微信项目/
├── src/                # 前端源代码 (React)
├── backend/            # 后端源代码 (Python)
│   ├── main.py         # 核心启动入口 (API + Scheduler)
│   ├── core/           # 核心业务逻辑模块
│   └── ...
├── config.json         # 系统配置文件 (自动生成)
├── app.log             # 系统运行日志
└── README.md           # 说明文档
```

---

## 3. 系统配置说明

### 3.1 基础配置 (`config.json`)
系统通过 Web 界面进行配置，底层存储在 `config.json` 中。

| 字段 | 说明 | 示例 |
| :--- | :--- | :--- |
| `monitor_folder` | **监控文件夹**。必须是绝对路径。 | `/Users/admin/Reports` |
| `wecom.corpid` | **企业ID**。企业微信后台获取。 | `wwf2c44...` |
| `wecom.secret` | **应用Secret**。自建应用的密钥。 | `j_I2EdJ...` |
| `wecom.agentid` | **应用AgentID**。 | `1000002` |
| `wecom.token` | **Token**。用于回调验证。 | `wechat123456` |
| `wecom.aes_key` | **EncodingAESKey**。用于消息加解密。 | `jWmYm7...` |
| `schedule.enabled` | **定时任务开关**。 | `true` / `false` |
| `schedule.time` | **发送时间**。24小时制。 | `10:29` |

### 3.2 企业微信后台配置 (关键)
为了让系统正常工作，必须在企业微信管理后台完成以下配置：

1.  **API 接收消息**:
    *   **URL**: 必须填入公网可访问的 URL (本系统通过 Serveo/cpolar 提供)。
    *   **Token/AESKey**: 必须与系统配置完全一致。
2.  **企业可信 IP**:
    *   在 `应用管理` -> `企业可信IP` 中，填入服务器的公网 IP (系统日志报错中会提示该 IP，如 `114.249.xx.xx`)。

---

## 4. 业务规则

### 4.1 文件发送规则
*   **触发方式**: 
    1.  **定时触发**: 达到设定时间（如 10:29）自动触发。
    2.  **手动触发**: 在仪表盘点击“立即执行”。
*   **文件选择逻辑**:
    *   系统会扫描 `monitor_folder` 下的所有文件。
    *   **忽略隐藏文件** (以 `.` 开头的文件)。
    *   按**修改时间**倒序排列，选择**最新**的一个文件进行发送。
*   **发送对象**:
    *   默认发送给 `@all` (应用可见范围内的所有人)。
    *   可在设置中指定具体的 `UserID` 或 `PartyID`。

### 4.2 错误处理
*   **上传失败**: 如果文件被占用或网络不通，重试逻辑需人工干预。
*   **IP 拦截**: 如果遇到 `60020` 错误，需更新企业可信 IP。
*   **签名错误**: 如果遇到 `403 Invalid signature`，需检查 Token 配置。

---

## 5. 使用指南

### 5.1 启动系统
在终端中分别启动前端和后端服务（或使用一键启动脚本）：

**后端**:
```bash
source venv/bin/activate
python backend/main.py
```

**前端**:
```bash
npm run dev
```

**内网穿透 (用于回调验证)**:
```bash
ssh -o StrictHostKeyChecking=no -R 80:localhost:8000 serveo.net
```

### 5.2 日常运维
*   **查看状态**: 访问 `http://localhost:5173` 查看仪表盘。
*   **日志排查**: 点击左侧“系统日志”菜单，实时查看运行情况。
*   **修改配置**: 在“设置”页面修改文件夹路径或定时时间，保存即生效（无需重启）。

---

## 6. 版本历史

*   **v1.0.0 (2026-02-07)**
    *   初始版本发布。
    *   完成核心监控与推送功能。
    *   解决企业微信回调签名验证问题 (WeChatPy Enterprise Crypto)。
    *   集成前端管理面板。
